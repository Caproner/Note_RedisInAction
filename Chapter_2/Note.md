# 第2章 使用Redis构建Web应用

本章主要从两个方面来讲如何使用Redis来优化Web应用的读写性能。包括：

+ 令牌cookie
+ 数据缓存

## 令牌cookie

由于http请求本身是无状态的，但很多场景下单纯的无状态请求又很难满足Web应用的需求（一个典型的例子就是登录）。故一般都会让浏览器存一些数据并在之后的请求将这些数据带给服务器。

这些额外存储的数据就是cookie。

cookie有如下两种方式：

+ 签名cookie：在cookie里面明文存储所有需要用到的信息，再附带一个签名用于防篡改
+ 令牌cookie：浏览器的cookie只存一个token串，服务器通过token串来查询得到需要用到的信息

前者可以节省服务器的数据读写时间（从MySQL里拉取用户信息是一个很费时的做法），但一旦数据量大，其传输成本也会增加；后者可以减少传输成本，但会增加服务器的数据读写操作。

由于cookie数据本身是非重要热数据，故可以将令牌cookie的服务端读写操作从MySQL换成Redis，这样便可以提升数据读写性能。

> 重要的数据一般需要有MySQL垫着（即采用Redis+MySQL同步的模式），不会直接将其完全托管给cookie。cookie一般都会存一些即使丢失了也影响不大的热数据（例如登录数据，丢失了就再登录一次就行了）

## 数据缓存

对于一些依赖于后端逻辑的热数据（例如物品记录，需要渲染的网页）而言，可以使用Redis来做定时缓存，以提升其读性能。

其标准模式如下：

+ 首先判断读取的内容是否是可缓存的
  + 如果不为可缓存的数据则直接去读后台数据
+ 其次判断Redis里面有没有相应数据
  + 如果有的话直接返回Redis相应数据
  + 没有的话直接去读后台数据，并将后台数据写一份到Redis并设置超时时间

### 多元数据的Redis缓存

对于一个仅用于Redis缓存的多元数据（例如说结构体），我们没有必要去使用一个哈希表对其每个属性都存一遍，而是直接将数据转换为JSON格式并以字符串形式存储。

因为我们并不需要去写其中某个属性的元素，在缓存的视角而言其就是一个整体，这种场景下使用字符串存取会比使用哈希表存取来得快。

### 限制缓存上限

如果需要让Redis缓存的记录量可控的话（例如限制其在100000条以内），则需要再开一个守护进程定时清掉超出的数据（可以清掉过旧的数据或访问量过少的数据）

### 减少缓存数量

如果对所有数据都采用这种方式进行缓存的话，可能会消耗巨量的内存，最终导致内存耗尽（毕竟内存贵呀）

于是对于较大的数据（例如网页），一般会多存一个记录表示其访问次数，然后根据其访问次数来决定其是否需要缓存。

这样对于不经常被访问的数据我们就没有必要腾出内存空间给它了。



