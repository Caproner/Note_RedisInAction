# 第7章 基于搜索的应用程序

本章将尝试构建一个基于Redis的搜索引擎，并同时实现广告定向和职位搜索

## 使用Redis进行搜索

首先需要明确搜索是做什么：搜索是根据关键词，在文档库中找出包含关键词的文档集合。

搜索引擎一般都需要做一件事情：**建立反向索引**

### 反向索引

对于文档而言，索引即为文档中的目录，也就是可以理解为文档跟文档中的词的映射关系

而反向索引则是反过来的，为单词与文档ID的映射关系

例如说文档A只有【Punching Kong】这段文字，文档B只有【Big King Kong】这段文字。

那么就需要建立如下索引：

+ 单词Punching映射至文档A
+ 单词Big映射至文档B
+ 单词Kong映射至文档A和文档B

用Redis的数据结构存储的话，这很适合使用集合进行存储。针对每个单词构建一个集合，集合中存储包含这个单词的文档ID。

#### 对整篇文档建立反向索引

针对一篇现成的，包含多个单词的文档，建立反向索引的步骤如下：

+ 标记化：找出其中的符合【单词】这个条件的词汇，例如说只包含英文字母和单引号的词汇。
  + 只需要扫一遍文档即可完成此事，并同时构建文档的单词集合
+ 移除非用词：非用词即为常见但没有提供信息的词汇，例如说be动词或代词之类的。
  + 这里需要一个存储非用词的常量集合，然后跟之前的文档的单词集合进行差集运算即可
+ 针对集合中的每个单词，找到对应的反向索引集合并将该文档添加进索引中

### 基本搜索操作

假设搜索行为只有一个关键词，则直接返回该关键词对应的反向索引集合即可。

但是正常的搜索行为包括如下：

+ 多个关键词：用户要求搜索包含多个关键词的文档集合。这个时候只需要对反向索引集合做交集即可
+ 同义词：用户列出多个同义词，要求文档包含其中任意一个即可。这个时候只需要对反向索引集合做1并集即可
+ 排除关键词：用户有时候会要求搜索结果中不包含某个关键词。这个时候只需要对指定关键词的反向索引集合做差集即可

根据用户不同的搜索行为（也有可能全都会用到），对指定的反向索引集合进行集合运算即可得到最终结果

### 对搜索结果进行排序

很多时候用户会要求对搜索结果按某个维度进行排序（例如说更新时间）。

这个时候我们需要额外的数据结构来记录每个文档的信息。这里我们针对每个文档使用一个Redis的哈希表来记录其信息（包括ID、创建时间戳、更新时间戳、标题等）。

于是我们便可以使用`SORT`的`BY`参数外联这些集合进行排序。

假定搜索结果集合名为`result`，集合内均为数字的文档ID，文档的信息哈希表名为`kb:doc:${id}`，例如说文档ID为16的信息哈希表名为`kb:doc:16`，其中更新时间戳为`updated`。那么对其排序的语句为：

```
SORT result BY kb:doc:*->updated
```

其中`*`为通配符，用于自动填充result里面的键进去

## 有序索引

上节使用的排序方式有一个问题就是，它仅可以使用单一维度进行排序。但很多时候都需要使用复合维度加计算进行排序。

于是需要换个思路，不使用`SORT`外联哈希表进行排序，而是使用创建一个临时的有序集合存储排序结果来进行排序。

于是，针对排序需要的信息，需要建一个有序集合来存储。以更新时间为例，新建一个有序集合，键为文档ID，值为更新时间，该集合存储所有文档的更新时间。

之后，需要排序的话，让搜索结果的集合跟有序集合（可以是多个）进行`ZINTERSTORE`运算即可。该运算还支持设置权重和设置聚合函数。

### 字符串维度排序

这个方法的弊端在于任何排序的维度都必须转化为浮点数（因为有序集合只能够按浮点数作为分值），这意味着当排序维度是字符串的时候，就需要做一个转化。

限于浮点数的位数（64位），不可能将字符串的所有信息都塞入浮点数中，故常用的转化方式为取前缀（前4个或6个）转化为257进制数字（留一个表示终止），或者取前缀（前6个或8个）转化为27进制数字（默认字符串全为小写的情况，并留一个表示终止）

## 广告定向

这里需要完成的是构建一个广告服务器，其功能为给网页提供合适且性价比高的广告。

广告服务器的接口可以做如下定义：

+ 请求：当前网页的特征词汇列表
+ 返回：广告ID

### 广告价格计算

一般而言，广告价格的计算方式有如下三种：

+ CPM：按展示次数计费（单位为千次/元）
+ CPC：按点击次数计费
+ CPA：按动作执行次数计费（例如在广告中购买/入会）

为了之后计算性价比的方便，我们需要统一用CPM来计算。即需要将CPC和CPA转化为期望CPM（也就是eCPM）。

这里直接使用平均点击率和平均动作执行率来换算就行了。

### 对广告建立索引

每个广告都会有关键词。于是我们可以仿照搜索引擎建立有序索引，其分值为eCPM。

### 执行广告定向

建立索引之后，通过词汇列表获取广告ID的过程就跟搜索一模一样了，根据词汇列表执行交集获取搜索结果并返回eCPM最大的一个。

#### 计算定向附加值

实际情况往往不会直接按eCPM排序获取最大，而是给eCPM加上一个附加值再排序获取最大。

这个附加值所代表的意义为【相关性】，其广告与单词相关性越大值就越大。

我们假设有了一个针对附加值的有序索引，针对每个单词而言都有一个有序集合，其键为广告ID，值为附加值。

理想的方法是求出广告针对词汇列表的加权平均值。但这么做很耗时间。

一个估算方法是只求出广告针对词汇列表的附加值中，最大值和最小值的平均值，作为广告针对当前词汇列表的附加值。

#### 定向附加值的学习

前面提到了针对附加值建立有序索引，但这个附加值并不是凭空而来的，而是需要根据用户的行为进行学习的。

记录用户针对每个特征单词的广告展示率、点击率、动作执行率，并依此使用统计学习方法（贝叶斯、机器学习等）换算出期望附加值即可。

## 职位搜索

这个相对比较简单，我们以【技能】为粒度，每个职位都会有一些需要满足的【技能】，而每个求职者也会有一些固有的【技能】。那么我们就可以仿照搜索引擎一样，用【技能】建立反向索引，并用求职者的技能列表进行搜索。