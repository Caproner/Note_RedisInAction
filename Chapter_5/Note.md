# 第5章 使用Redis构建支持程序

本章举了几个例子说明Redis在构建支持程序的作用，包括：

+ 记录日志
+ 记录计数器和访问统计数据
+ 查询IP所在的国家和地区
+ 服务发现与配置

## 日志记录

日志通常由服务和日志级别（INFO、WARNING、ERROR等）区分，并分别存入不同文件。有的还会按照日期进行日志划分。

Redis日志记录的思想是替代日志存入文件的做法，将日志存入Redis列表里。

但由于内存有限，Redis只会存近期日志。也就是说，列表每次`LPUSH`新的日志的时候，都需要使用`LTRIM`截取最新的日志。

### 统计日志频率

日志记录有一个需求是，统计某段时间内的日志频率。

对于Redis来说只需要开一个有序集合即可，按时间段开有序集合（例如说每隔一小时新建一个有序集合，旧的有序集合就归档），有序集合的分数即为消息出现的频率。

## 计数器和统计数据

这类需要有两种：简单计数器和实数统计数据

### 计数器

对于计数器需求而言，仅需要记录次数即可。例如说【点击次数】。

所以只需要一个哈希表记录键及其计数器即可。

如果需要清理旧计时器的话只需要：

+ 开个守护进程，定时遍历并清除旧的记录
+ 修改存储方式，并使用`EXPIRE`进行清理即可

### 统计数据

对于实数统计数据而言，记录的信息就不单单是【次数】，还需要包括其他信息，如最小值，最大值等。

这个时候就需要使用一个有序集合来存储信息。这个有序集合的键为记录的量的名字【例如最小值、最大值、和、计数、平方和等】，值为其对应的浮点数值。

那么当有新的数据进来的时候，只需要：

+ 对于和、计数、平方和而言，使用`ZINCRBY`即可
+ 对于最小值和最大值而言，则需要使用`ZUNIONSTORE`（以最小值为例）
  + 假设现在有一个统计数据的有序集合，其记录最小值的键名为`min`
  + 新来一个数据之后，先创建一个有序集合，其只有一个键为`min`，对应的分值为这个数据
  + 然后使用`ZUNIONSTORE`操作，将原集合和新建的集合以`MIN`的规则求并，并存入原集合即可

## 查找IP所属的城市及国家

这个问题的本质是读取文件中存储的数据于Redis并提供查找

这里有的数据包括：

+ IP地址段跟城市的映射
+ 城市跟城市信息的映射

后者只需要一个哈希表即可，前者为了加速查询需要使用有序集合，其中需要将IP按256进制转换回数字并作为分值。

## 服务的发现与配置

这里的本质思想为：使用Redis字符串读写JSON化的配置信息，包括服务的IP地址（用于服务发现）和服务的配置。